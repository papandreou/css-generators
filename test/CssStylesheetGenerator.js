const expect = require('./expect');
const chanceCache = require('chance-generators/lib/chanceCache');

const CssStylesheetGenerator = require('../lib/CssStylesheetGenerator');

describe('CssStylesheetGenerator', () => {
  beforeEach(() => chanceCache.clear());

  it('should generate a CSS stylesheet', () => {
    expect(new CssStylesheetGenerator().take(10)).toEqualSnapshot([
      '@keyframes sidfanu {\n  to {\n  border-image-outset: 2718165087813632; animation-direction: normal; vertical-align: bottom; scroll-padding-bottom: -998.4425em;\n}\n}\n::slotted([ jimab | lel ] ::gemsibsof:ow) { mask-border: 3318847205539840 url(ebik) repeat luminance; outline-color: invert; contain: strict; list-style-image: url(gazziw); font-variant-alternates: swash(uhlog) annotation(sezsi) ornaments(ju) historical-forms stylistic(bu) character-variant(mahbu) styleset(wot); }\n:target { block-size: fit-content(302.1541cm); text-orientation: sideways; scroll-padding-top: -338.204cm; background-position: center bottom; }\n:first-child { padding-right: 64%; clip-path: none; mask-border: 76% fill / / -12.4088ch paint(biga , 31%); mask-border: round luminance cross-fade(7% paint(fuw , 266.8075cm) , cross-fade( conic-gradient(from -351.31turn , Background ,  currentcolor,  rgba(53%), rgb(-2925265000857600) -353.5941deg 71%, rgb(-4433065824747520 , -4471492611932160) 424.5412grad , rgb(1973735510769664 / 41%) ))); }\n:empty { text-emphasis-style: dot; margin-block: 45%; }\n::slotted(heajiupe | dovki #envewi ::ta ( round ):pufoj ( auto )) { text-shadow:  -542.9Q; border-inline-end-width: thick; }\n::selection { list-style: symbols() none; mask: match-source view-box url(movecuaw) top -797.057vw right 0% fill-box repeat-y subtract; overscroll-behavior: none; }\n:optional { border-top: rgb(49%); border-inline-start: inset midnightblue thin; mask-border-outset: -7319704678957056; letter-spacing: normal; offset: Q -13,59 Q 1,29 Q 34,-2 L -61,-54 L 0,-44 Q -96,54 Q -92,-65 L 89,-6 L -44,83 L -26,50 M 91,86 M -14,11 L 15,93 L 71,-85 M -39,-23 M 71,-47 M -3,-66 Q 11,-21 L 69,39 view-box 230.0145rem / auto; }\n:disabled > :link { text-align-last: end; page-break-inside: avoid; }\n:read-write { overscroll-behavior-y: auto; }\n:fullscreen { column-rule-color: hsl(5586506248880128 , 25% , 87% , 8%); line-break: auto; justify-items: unsafe left; }\n[data=cuvbe] { border-block-end-style: solid; mask-border-width: auto; animation-timing-function: linear; }\n:last-child { margin-inline: auto; }\n:enabled { mask-mode: match-source; animation-name: none, none; scroll-padding: auto; font: menu; border-bottom-width: thin; }\n:link { resize: both; border-start-end-radius: 62%; grid-template-rows: none; scroll-padding-inline-end: auto; border-left-style: double; }\n:in-range { overscroll-behavior-x: none; border-image: cross-fade(40% image(rgb(-8550520868306944)) , cross-fade(41% url(fig))) fill 2885859288285184 / 8194124427558912 round; page-break-before: right; }\n:nth-child(even of las #da ::ku:nazinef ( none ) + [ bo | pumvapop ~ = otilip ] ::awoazifa:de) { backdrop-filter: none; }\n',
      "@charset \"SEN_850200_C\" ;\n@charset \"ISO-8859-8-E\" ;\n:hover { overflow-inline: visible; flex-basis: -436.2905pt; border-bottom-left-radius: 70%; flex-grow: 2322827751456768; touch-action: manipulation; }\n#azrazi { mask-border-source: cross-fade( image(rtl InfoBackground) , element(#zoglupit)); font-synthesis: none; column-rule-style: inset; border-block-start: thick currentcolor; border-block-end-color: hsl(900.124rad 96% 48% / 2374968125947904); }\n, { border-block-end-color: hsl(967428175560704 , 67% , 21% , 79%); scale: -6963202684354560; border-block-end-color: InactiveCaption; }\n::selection { writing-mode: vertical-lr; }\n* { page-break-after: verso; margin-inline-end: 71%; border-bottom-left-radius: 14%; }\n:read-only { scroll-padding-inline: 10%; scroll-padding-inline-start: auto; grid-auto-flow: row dense; scroll-padding: 14%; }\n[inputmode=un] { shape-margin: 760.72vmax; border-top-style: outset; }\n::first-letter { mask-origin: view-box; flex-grow: -2229109212053504; padding-block: -36.666vh; font-variation-settings: 'ihmi' -4437267431030784, 'ni' -7992929603813376, 'zatossez' -1797424519577600, 'jarek' 8344675337371648; scroll-margin-bottom: -975.6911vw; }\n::selection { backface-visibility: visible; text-decoration-skip-ink: auto; margin: auto; }\n::slotted(ucite [ wijwawuz ] ::nakefti:selu) { word-break: break-all; overscroll-behavior-inline: contain; }\n:not(. sogfu ::okotukov:falo ( 974.5523turn ) [ evicib = 'ca' s ] ::zuwsos ( 85% ):ne) { box-sizing: border-box; }\n:empty { border-right-style: dotted; text-align-last: right; place-self: baseline; clear: none; }\n.piemeamu { border-block-end: rgba(-8488696651186176) thick ridge; min-height: min-content; overscroll-behavior-y: auto; }\n:checked { border-end-start-radius: 1%; widows: -30%; max-height: min-content; offset: L 46,-31 Q 3,-10 L 83,-21 / bottom -81.3064vmin right 537.8355ex; background-position: left 49%; }\n",
      "@font-face {\n  font-variation-settings:normal ; src:url(garmunir) format('geb'), local('kadi'), url(lelam) ; unicode-range:U+b0bd-b3db ; font-family:'civoj' ; font-stretch:normal ; font-style:normal ;\n}\n:empty { scroll-margin-inline: -830.966vh; mask-repeat: repeat-x; word-break: normal; margin-block-start: 93%; inset-block-start: 236.5096vh; }\n:focus { height: max-content; perspective: none; animation-timing-function: linear; }\n:disabled { padding-block-start: 90%; }\n::backdrop { perspective-origin: left; shape-outside: circle(); clear: inline-start; }\n:hover { animation-direction: alternate; }\n:first-child { border-right-width: -345.0053px; border-bottom-right-radius: 781.0546mm; mask-origin: fill-box; overflow-block: hidden; scroll-behavior: smooth; }\n:left { border-block-width: medium; margin-block-start: auto; mask-image: cross-fade(element(#je)  , #921e86); }\n",
      ":left { display: none; border-top-style: none; border-block-start: thin; box-decoration-break: slice; border-inline-color: currentcolor; }\n:active { column-fill: balance-all; }\n* || ::cue-region([draggable=moudu]) { mask-border-source: conic-gradient(at left 67% bottom 72% ,  hsl(-589.8449deg , 97% , 32% , -5413201948704768) 24%, 77% hsl(12.2079deg 94% 48%) 5%, hsla(-873.2501rad 99% 20%) 8% , rgb(-6904989897195520 , -512037851496448) 588.5789grad); border-block-start-style: outset; }\n::backdrop { perspective: -182.9634cm; text-underline-position: left under; font-size: xxx-large; page-break-inside: avoid; mask-border-slice: 6157839831662592 fill; }\n::after > :valid { border-radius: 16% / -627.1901vmax; border-top-style: groove; object-position: -367.6069vmin center; overflow-wrap: anywhere; }\n:lang(kk) { font-variation-settings: 'ropi' -4824027172438016, 'memcug' 2238072771051520, 'muto' -2974076112994304; overscroll-behavior-block: contain; border-inline-width: thick; text-combine-upright: all; }\n:left { page-break-inside: avoid; mask-border-slice: 100%; place-content: first baseline start; }\n:nth-last-child(odd of:amlu ( url(mit) -700.1652pt -541.4972pc ns-resize ) ::tisirse ( auto ):semiop ( none no-repeat padding, url(tas) repeat-y border left padding, content, content right bottom url(hin) repeat-y border, border ) * [ ruoji ] ::olibi:gi ( none )) { animation-play-state: paused; contain: strict; scale: -4006633348792320; }\n",
      "@font-face {\n  font-variation-settings:'gihkak' 4502887560380416 ; font-feature-settings:normal ;\n}\n@font-face {\n  font-style:oblique 129.6823rad ; unicode-range:U+10d2-ca4f ; src:local(mizac), url(cusje) format('mubfur'), local(reha) ; font-weight:99221252341760 ; font-family:'kogup' ; font-variation-settings:'agwoveze' 8005773888061440, 'gikubo' -7466814577573888 ; font-feature-settings:'baf' on ; font-variant:none ;\n}\n:in-range { text-decoration-style: wavy; scroll-margin-right: 249.5226mm; filter: none; scroll-padding-block: auto; }\n:focus { animation-play-state: running; scroll-padding-block-end: -181.1767vh; margin-left: 44%; }\n::before { border-start-start-radius: 98%; position: sticky; }\n::before + :nth-last-child(even of | bizi [ fo ^ = ifo ] ::oma ( space-between ):ri + * #fe ::wig ( first baseline ):ekizi) > :in-range { flex-wrap: nowrap; }\n::placeholder { border-inline-start-style: none; border-block-end: hsla(-1131423192842240 , 35% , 92% , 30%) medium; mask-border-outset: -431437647970304; font-variant-alternates: annotation(ficul) stylistic(fepnajlo) character-variant(wonig) historical-forms ornaments(cob) styleset(janleaw) swash(aznifru); }\n",
      "@keyframes 'vorezepof' {\n  99% {\n  transform-box: stroke-box;\n}\n}\n@font-face {\n  font-stretch:semi-expanded ;\n}\n@keyframes 'siw' {\n  from {\n  border-bottom-right-radius: 73%;\n}\n}\n:first { text-shadow: none; }\n::selection { transform-box: stroke-box; inline-size: max-content; shape-margin: 689.0988pc; }\n:first-child { scroll-padding-block-end: 300.3347px; font-feature-settings: normal; mask: margin-box; }\n:read-write { flex-basis: content; padding-inline-start: -869.2874px; counter-increment: none; }\n:not(| * [ hibiz | if | = cubcoma ] ::iguza:rohac . jog ::bu ( auto ):mo) { border-start-start-radius: 95%; }\n:valid { break-before: avoid; mask-mode: luminance; width: fit-content(95%); mask-size: cover; }\n::first-letter { word-spacing: normal; paint-order: fill; font-variant-east-asian: proportional-width jis04 ruby; border-bottom-right-radius: -906.1093em; }\n:hover { animation-timing-function: linear; transition-duration: 559.169s; }\n:fullscreen { background-color: wheat; border-start-end-radius: 52%; text-transform: lowercase; writing-mode: vertical-lr; border-inline-end-style: dotted; }\n:indeterminate { place-self: stretch right; scroll-margin-right: -73.2385ex; min-inline-size: 495.7432px; }\n#sucik { clip: rect(-46.6463vmin , -911.2467vw , 704.3871vmax , -929.1553vmax); display: none; }\n:nth-child(odd) { font-variant-numeric: normal; font-language-override: normal; }\n:disabled { padding-inline-end: -8.2485pt; border-block-color: ButtonShadow; border-block-start-width: medium; text-decoration-style: solid; }\n::slotted(pianevin:povhudfoj ::ora ( outside ):iv ( -989.7097ms all -542.7497s step-start )) { scroll-margin-top: 112.3635vmax; }\n:scope { break-before: auto; border-left-color: hsl(-347.1329turn 56% 63%); break-inside: avoid; }\n:only-of-type { margin-bottom: auto; }\n",
      "@font-face {\n  font-stretch:ultra-condensed ; font-family:awvooh ; font-variant:normal ;\n}\n@keyframes 'sij' {\n  from {\n  border: currentcolor; word-spacing: 97%; grid-row-start: baahpu 54%; box-sizing: border-box;\n}\n}\n@font-face {\n  src:local(jevzova) ; unicode-range:U+45f4 ; font-variant:normal ; font-variation-settings:normal ; font-feature-settings:normal ;\n}\n:right { text-indent: hanging  27%; grid-row-end: span zebuwen; shape-margin: -53.5802px; unicode-bidi: normal; border-inline-start-width: 737.2464cm; }\n:target { right: 85%; }\n:not(iw | golbador #gelco ::so ( hsla(-637734913835008 7% 68%) ):sohvov || | feunbi . wezaw ::rav:ac) { font-variant-alternates: normal; border-end-end-radius: 57%; }\n",
      ":read-write { scroll-padding: auto; backdrop-filter: none; outline-width: 903.1Q; border-bottom-style: ridge; text-decoration-thickness: auto; }\n:nth-of-type(odd) { background-blend-mode: soft-light; margin-bottom: 418.1211vw; table-layout: fixed; padding-block-start: 80%; }\n:target { max-inline-size: max-content; inset-block-start: 321.6402vmin; }\n:nth-child(even of * . ranas ::taip:nes * [ bop ] ::rul:mo ( linear )) { animation-name: none, usi; page-break-inside: avoid; grid-auto-flow: row dense; }\n:scope { justify-self: auto; margin-inline: auto; line-height: 176.1168pc; animation-iteration-count: -1882231429660672; inset-inline: 88%; }\n:nth-of-type(odd) { grid-area: 19%  / span esezo; font-variant-ligatures: no-common-ligatures no-discretionary-ligatures contextual; font-weight: lighter; background-size: cover; }\n:invalid { border-block-end-width: thick; font-variant-ligatures: none; }\n:nth-of-type(even) { font: message-box; mask-origin: padding-box; font-synthesis: none; }\n::selection { break-before: avoid-region; orphans: -99%; }\n:first-child { right: 13%; font-variant-alternates: character-variant(ner) historical-forms; scroll-padding-block-end: auto; }\n:invalid { box-shadow: -494.9445em  ; font-size: large; page-break-after: avoid; }\n:out-of-range { inline-size: max-content; scroll-padding-left: 45%; mask-composite: exclude; }\n::before { border-right-color: #1ca6c3; animation-play-state: running; word-break: normal; }\n:not(: del ::kasarmu:baztusig ~ . fabkaofo ::gas ( border-box ):hoezuva ( large )) ~ ::after { shape-margin: 77%; animation-name: 'vofvuktic'; flex-grow: 2843488311836672; border-inline-end: outset thick hsla(504.8555turn , 9% , 57%); page-break-before: auto; }\n",
      "@charset \"IBM904\" ;\n@font-face {\n  font-stretch:ultra-expanded ; font-variant:historical-ligatures historical-forms ornaments(basar) all-petite-caps no-common-ligatures stylistic(peezipub) stacked-fractions swash(lari) ; font-variation-settings:normal ; font-style:italic ; font-weight:bold ; font-feature-settings:'ruswum' ; unicode-range:U+d288-e61f ; font-family:ogo ; src:url(ol), url(po), local('otrihto'), local('mud'), local('efo') ;\n}\n@charset \"BS_viewdata\" ;\n:required { border-block-start-style: ridge; mask-border-outset: -486.8745vmin; }\n::placeholder { inset-block-start: 611.9851vmax; margin-left: 4%; list-style-type: 'bop'; }\n:visited { text-decoration-color: #3a636f; scroll-margin-block: -575.9104Q; max-inline-size: -177.9431mm; }\n::backdrop { text-emphasis: none hsl(-4056733844504576 , 73% , 83% , 3088112246849536); outline-style: none; quotes: auto; border-image-source: none; grid-auto-columns: minmax(-663.9716ex , max-content); }\n::cue(:last-child) { margin-block-end: -643.1081ch; content: none; }\n:dir(rtl) { margin-inline-end: 23%; break-after: page; }\n:only-of-type { background-image: none; border-image-outset: -4061521600577536; border-end-start-radius: 70%; }\n:read-only { grid-row-end: wobkat; border-block-start-color: #b96e44; flex: -7576507073429504 content; }\n:optional { mask-position: center; border-top-color: hsl(-861.1524grad 52% 84%); outline-width: thick; background-size: auto; margin-bottom: 760.1582px; }\n:optional { margin-block: -351.3325pc; empty-cells: show; outline-width: 988.2788mm; outline-color: #fed7cf; }\n:right { hyphens: manual; background-image: element(#ufo); overflow-y: scroll; }\n:checked { margin-block-end: 9%; }\n:in-range { scroll-padding: -304.857in; outline-offset: 962.4728vh; inline-size: fit-content(-530.7159cm); }\n:indeterminate { border-image-width: 74%; text-transform: full-width; margin-bottom: 684.0666rem; list-style-image: url(doedo); scroll-padding-block-start: 16%; }\n",
      "@font-face {\n  unicode-range:U+3d32 ; src:url(on) format('otsu'), local(pudi), local(imuado), url(cek), url(hez) format('otipu') ;\n}\n@font-face {\n  font-variation-settings:'fojci' -8542213340397568, 'huro' 8391506159206400, 'se' 7862369405370368, 'nectaf' -8688564044824576, 'tedci' 5057751147347968 ; font-variant:normal ; font-family:'pu' ; font-weight:-7966317168558080 ; font-feature-settings:'ukfado' ; font-style:normal ; unicode-range:U+19de-b928 ; font-stretch:expanded ; src:local(hof), url(viv), local('miplemit') ;\n}\n:right || :hover { transition-timing-function: linear; box-decoration-break: slice; border-end-end-radius: -162.8388ch; scroll-margin: -480.3736px; }\n:scope { border-end-start-radius: 70.6203Q; border-spacing: -352.9992ch -517.5971Q; white-space: pre; scroll-margin-bottom: -870.7667vw; }\n",
    ]);
  });

  it('supports configuring the at-rules', function () {
    expect(
      new CssStylesheetGenerator({
        minAtRules: 1,
        maxAtRules: 1,
        minStyleRules: 0,
        maxStyleRules: 0,
        atRules: { type: '@charset' },
      }).take(10)
    ).toEqualSnapshot([
      '@charset "CP51932" ;\n',
      '@charset "EBCDIC-AT-DE" ;\n',
      '@charset "PT" ;\n',
      '@charset "ISO_646.basic:1983" ;\n',
      '@charset "IBM866" ;\n',
      '@charset "ISO-2022-JP" ;\n',
      '@charset "ISO-8859-5" ;\n',
      '@charset "IBM861" ;\n',
      '@charset "GB_2312-80" ;\n',
      '@charset "windows-1258" ;\n',
    ]);
  });

  it('supports configuring the style rules', function () {
    expect(
      new CssStylesheetGenerator({
        minAtRules: 0,
        maxAtRules: 0,
        minStyleRules: 1,
        maxStyleRules: 1,
        styleRules: { declarationList: { min: 1, max: 1 } },
      }).take(10)
    ).toEqualSnapshot([
      '::marker { padding-right: 60%; }\n',
      ':lang(cu) { background-image: none; }\n',
      ':nth-of-type(8n+7) { background-color: ThreeDDarkShadow; }\n',
      ':checked { border-inline-start-color: ButtonHighlight; }\n',
      ':only-child { align-items: stretch; }\n',
      ':not(uj #apli ::cuval ( -973.4701vw ):ajedehir ( 50% ) >:vo ::ginbu:okonokan ( space-between )) { cursor: url(zeenejom) pointer; }\n',
      '[contenteditable=zejaaf] || :required { padding-left: 77%; }\n',
      '::first-line { opacity: 7475248958013440; }\n',
      ':only-of-type { display: block; }\n',
      ':out-of-range { mask-origin: stroke-box; }\n',
    ]);
  });

  describe('when shrinking', function () {
    it('should shrink', function () {
      const generator = new CssStylesheetGenerator();
      expect(generator).toShrinkTowards(
        '::slotted([ jimab | lel ] ::gemsibsof:ow) { list-style-image: url(gazziw); }\n'
      );
    });

    it('should honor the minStyleRules setting of the original generator', function () {
      const generator = new CssStylesheetGenerator({
        minStyleRules: 2,
        minAtRules: 0,
      });
      expect(generator).toShrinkTowards(
        ':target { scroll-padding-top: -338.204cm; }\n' +
          ':optional { letter-spacing: normal; }\n'
      );
    });

    it('should honor the minAtRules setting of the original generator', function () {
      const generator = new CssStylesheetGenerator({
        minAtRules: 2,
        minStyleRules: 0,
      });
      expect(generator).toShrinkTowards(
        '@keyframes sidfanu {\n' +
          '  to {\n' +
          '  border-image-outset: 2718165087813632; animation-direction: normal; vertical-align: bottom; scroll-padding-bottom: -998.4425em;\n' +
          '}\n' +
          '}\n' +
          '@keyframes tima {\n' +
          '  from {\n' +
          '  max-inline-size: 14%; background: padding-box right / contain repeat-x rgb(7965998619557888 , 81%) fixed left border-box; overflow-wrap: normal;\n' +
          '}\n' +
          '}\n'
      );
    });
  });
});
